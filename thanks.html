<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanks for registering for October Big Day 2025!</title>
    <link rel="shortcut icon" href="https://shop.birdsociety.sg/static/img/favicon/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:ital,wght@0,100..900;1,100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-49LNESP0V4"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-49LNESP0V4');
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'hanken': ['Hanken Grotesk', 'sans-serif'],
                        'noto': ['Noto Sans', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#35409a',
                        'primary-light': '#4D59B6',
                        'primary-dark': '#0D1462',
                    }
                }
            }
        }
    </script>
</head>
<body class="font-noto bg-gradient-to-br from-slate-50/80 via-green-50/80 to-emerald-50/80 min-h-screen">
    <!-- Navigation (mirrors index.html styling) -->
    <nav class="w-full bg-white/90 backdrop-blur-sm shadow-sm">
        <div class="container mx-auto px-6 py-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <a href="/" class="flex items-center">
                        <img src="assets/img/birdsoc-logo.png" alt="Bird Society Logo" class="h-8 md:h-10 w-auto mr-2">
                        <div class="h-8 md:h-10 border-l-2 border-gray-300 mx-2"></div>
                        <img src="assets/img/logo.png" alt="October Big Day 2025" class="h-12 md:h-14 w-auto">
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-10">
        <div class="max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="font-hanken font-bold text-3xl md:text-4xl text-primary mb-2">Thanks for registering for October Big Day 2025!</h1>
                <p class="text-gray-700">Please share a few additional details below.</p>
            </header>

            <div id="app" class="bg-white/90 backdrop-blur-sm rounded-2xl p-4 md:p-8 shadow-xl">
                <!-- Schema load / error states -->
                <div id="schemaError" class="hidden text-red-700 bg-red-50 border border-red-200 rounded-xl p-4 mb-4"></div>
                <div id="loadingState" class="space-y-3">
                    <div class="animate-pulse bg-gray-100 h-10 rounded-lg"></div>
                    <div class="animate-pulse bg-gray-100 h-10 rounded-lg"></div>
                    <div class="animate-pulse bg-gray-100 h-10 rounded-lg"></div>
                </div>

                <form id="dynamicForm" class="space-y-5 hidden" novalidate>
                    <div id="formFields" class="grid md:grid-cols-1 gap-4"></div>

                    <div class="flex items-center gap-3 pt-2">
                        <button type="submit" id="submitBtn" class="bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="btn-text">Submit</span>
                            <span class="btn-loading hidden">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span>Submitting…</span>
                            </span>
                        </button>
                        <div id="submitStatus" class="text-sm text-gray-600"></div>
                    </div>
                </form>
            </div>

            <div class="text-center mt-6">
                <a href="index.html" class="text-primary hover:text-primary-dark underline">Back to event page</a>
            </div>
        </div>
    </main>

    <script>
        // Mirror API base URL logic from index.html
        const API_BASE = (function(){
            if (window.__API_BASE) return window.__API_BASE;
            const host = location.hostname;
            if (host === 'localhost' || host === '127.0.0.1' || host === '') return 'http://localhost:8000/api/v1';
            return 'https://shop.birdsociety.sg/api/v1';
        })();

        // Utilities
        function sentenceCase(key) {
            return String(key || '')
                .replace(/([A-Z])/g, ' $1')
                .replace(/[_-]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim()
                .toLowerCase()
                .replace(/^\w/, c => c.toUpperCase());
        }

        function schemaFieldControl(key, schemaProp, required) {
            const type = schemaProp.type;
            const label = schemaProp.title || sentenceCase(key);
            const desc = schemaProp.description || '';
            const req = required ? 'required' : '';
            const common = `name="${key}" data-key="${key}" ${req} class=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary\"`;

            // If display is explicitly false, render a hidden field (still prefillable and submitted)
            const hide = (v) => v === false || v === 0 || v === 'false' || v === '0';
            if (hide(schemaProp.display) || hide(schemaProp['x-display'])) {
                return `<input type="hidden" name="${key}" data-key="${key}">`;
            }

            // enum as select
            if (schemaProp.enum) {
                const emptyOpt = '<option value="">Select...</option>';
                const opts = schemaProp.enum.map(v => `<option value="${String(v)}">${String(v)}</option>`).join('');
                return `<div><label class="block text-gray-700 text-sm mb-1">${label}${required?' *':''}</label><select ${common}>${emptyOpt}${opts}</select>${desc?`<div class='text-xs text-gray-500 mt-1'>${desc}</div>`:''}</div>`;
            }
            // boolean as checkbox
            if (type === 'boolean') {
                return `<div class="col-span-2"><label class="inline-flex items-center gap-2 text-gray-700 text-sm"><input type="checkbox" ${common}><span>${label}${required?' *':''}</span></label>${desc?`<div class='text-xs text-gray-500 mt-1 ml-6'>${desc}</div>`:''}</div>`;
            }
            // numeric
            if (type === 'integer' || type === 'number') {
                const step = type === 'integer' ? '1' : 'any';
                const min = schemaProp.minimum != null ? `min="${schemaProp.minimum}"` : '';
                return `<div><label class="block text-gray-700 text-sm mb-1">${label}${required?' *':''}</label><input type="number" ${min} step="${step}" ${common} />${desc?`<div class='text-xs text-gray-500 mt-1'>${desc}</div>`:''}</div>`;
            }
            // string — check format for email/date/tel for nicer UX
            const fmt = (schemaProp.format || '').toLowerCase();
            const inputType = fmt === 'email' ? 'email' : (fmt === 'date' ? 'date' : (fmt === 'phone' || fmt === 'tel' ? 'tel' : 'text'));
            return `<div><label class="block text-gray-700 text-sm mb-1">${label}${required?' *':''}</label><input type="${inputType}" ${common} />${desc?`<div class='text-xs text-gray-500 mt-1'>${desc}</div>`:''}</div>`;
        }

        function buildFormUI(schema) {
            if (!schema || schema.type !== 'object' || !schema.properties) return '';
            const reqSet = new Set(schema.required || []);
            const keys = Object.keys(schema.properties || {});
            return keys.map(key => schemaFieldControl(key, schema.properties[key] || {}, reqSet.has(key))).join('');
        }

        // Accept multiple schema shapes and normalize to JSON Schema-like
        function normalizeSchema(input) {
            if (!input) return null;
            let s = input;
            // Unwrap common wrappers
            if (s && typeof s === 'object') {
                if (s.schema && typeof s.schema === 'object') s = s.schema;
                else if (s.data && typeof s.data === 'object') {
                    if (s.data.schema) s = s.data.schema; else if (Array.isArray(s.data.fields)) s = s.data;
                }
                else if (s.result && typeof s.result === 'object') s = s.result;
            }
            // Already JSON schema?
            if (s && s.type === 'object' && s.properties) return s;
            // Fields array shape -> convert
            const fields = Array.isArray(s) ? s : (Array.isArray(s.fields) ? s.fields : null);
            if (fields) {
                const properties = {};
                const required = [];
                fields.forEach(f => {
                    const key = f.name || f.key || f.id;
                    if (!key) return;
                    let type = (f.type || 'string').toLowerCase();
                    let schemaProp = { type: 'string' };
                    if (type === 'integer' || type === 'number') {
                        schemaProp.type = type;
                    } else if (type === 'boolean' || type === 'checkbox' || type === 'switch') {
                        schemaProp.type = 'boolean';
                    } else if (type === 'select' || type === 'dropdown') {
                        schemaProp.type = 'string';
                        const opts = f.options || f.choices || [];
                        schemaProp.enum = opts.map(o => typeof o === 'object' ? (o.value ?? o.id ?? o.name ?? o.label ?? '') : String(o));
                    } else if (type === 'email' || type === 'date' || type === 'tel' || type === 'phone') {
                        schemaProp.type = 'string';
                        schemaProp.format = type;
                    } else {
                        schemaProp.type = 'string';
                    }
                    if (f.minimum != null) schemaProp.minimum = f.minimum;
                    if (f.display !== undefined) schemaProp.display = f.display;
                    if (f.title) schemaProp.title = f.title;
                    if (f.label && !schemaProp.title) schemaProp.title = f.label;
                    if (f.description) schemaProp.description = f.description;
                    if (!schemaProp.description && f.help_text) schemaProp.description = f.help_text;
                    properties[key] = schemaProp;
                    if (f.required === true) required.push(key);
                });
                return { type: 'object', properties, required };
            }
            // Unknown shape: return null
            return null;
        }

        function findQueryValue(params, key) {
            if (!params) return null;
            // Try exact key
            if (params.has(key)) return params.get(key);
            // Try hyphen/underscore variants
            const alt1 = key.replace(/_/g, '-');
            const alt2 = key.replace(/-/g, '_');
            if (params.has(alt1)) return params.get(alt1);
            if (params.has(alt2)) return params.get(alt2);
            return null;
        }

        function parseValueForType(val, schemaProp) {
            if (val == null) return null;
            const t = (schemaProp && schemaProp.type) || 'string';
            if (t === 'boolean') {
                const v = String(val).toLowerCase();
                return v === 'true' || v === '1' || v === 'yes' || v === 'y';
            }
            if (t === 'integer') {
                const n = parseInt(String(val), 10);
                return Number.isNaN(n) ? null : n;
            }
            if (t === 'number') {
                const n = parseFloat(String(val));
                return Number.isNaN(n) ? null : n;
            }
            return String(val);
        }

        function prefillFromQuery(schema) {
            const params = new URLSearchParams(window.location.search || '');
            if (!schema || !schema.properties) return;
            const keys = Object.keys(schema.properties);
            keys.forEach(key => {
                const prop = schema.properties[key] || {};
                const raw = findQueryValue(params, key);
                if (raw == null) return;
                const parsed = parseValueForType(raw, prop);
                const el = document.querySelector(`[data-key="${CSS.escape(key)}"]`);
                if (!el) return;
                if (prop.type === 'boolean' && el.type === 'checkbox') {
                    el.checked = Boolean(parsed);
                } else if (el.tagName === 'SELECT') {
                    // Only set if value exists in options
                    const exists = Array.from(el.options).some(o => o.value === String(parsed));
                    if (exists) el.value = String(parsed);
                } else {
                    el.value = parsed != null ? String(parsed) : '';
                }
            });
        }

        function collectFormData(schema) {
            const data = {};
            const props = (schema && schema.properties) || {};
            for (const key of Object.keys(props)) {
                const prop = props[key] || {};
                const el = document.querySelector(`[data-key="${CSS.escape(key)}"]`);
                if (!el) continue;
                if (prop.type === 'boolean') {
                    if (el.type === 'checkbox') {
                        data[key] = Boolean(el.checked);
                    } else {
                        const v = (el.value || '').trim().toLowerCase();
                        data[key] = v === 'true' || v === '1' || v === 'yes' || v === 'y';
                    }
                } else if (prop.type === 'integer') {
                    const n = parseInt(el.value || '');
                    if (!Number.isNaN(n)) data[key] = n; else data[key] = null;
                } else if (prop.type === 'number') {
                    const n = parseFloat(el.value || '');
                    if (!Number.isNaN(n)) data[key] = n; else data[key] = null;
                } else {
                    data[key] = (el.value || '').trim();
                }
            }
            return data;
        }

        function setSubmittingState(isSubmitting) {
            const btn = document.getElementById('submitBtn');
            if (!btn) return;
            const txt = btn.querySelector('.btn-text');
            const loading = btn.querySelector('.btn-loading');
            btn.disabled = isSubmitting;
            if (txt && loading) {
                if (isSubmitting) { txt.classList.add('hidden'); loading.classList.remove('hidden'); }
                else { txt.classList.remove('hidden'); loading.classList.add('hidden'); }
            }
        }

        async function init() {
            const schemaUrl = `${API_BASE}/forms/october-big-day-2025/schema`;
            const submitUrl = `${API_BASE}/forms/october-big-day-2025/submit`;
            const loading = document.getElementById('loadingState');
            const errBox = document.getElementById('schemaError');
            const form = document.getElementById('dynamicForm');
            const fields = document.getElementById('formFields');
            const status = document.getElementById('submitStatus');

            try {
                const res = await fetch(schemaUrl);
                if (!res.ok) throw new Error(`Failed to load form schema (${res.status})`);
                const rawSchema = await res.json();
                console.log('Form schema (raw):', rawSchema);
                const schema = normalizeSchema(rawSchema);
                console.log('Form schema (normalized):', schema);

                const html = buildFormUI(schema);
                if (!html) {
                    fields.innerHTML = '<div class="col-span-2 text-gray-600">No fields available for this form. Please try again later.</div>';
                } else {
                    fields.innerHTML = html;
                }
                loading.classList.add('hidden');
                form.classList.remove('hidden');

                // Prefill from query string
                if (schema) prefillFromQuery(schema);

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    status.textContent = '';
                    // Basic HTML5 validation
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    setSubmittingState(true);
                    try {
                        const payload = schema ? collectFormData(schema) : {};
                        const resp = await fetch(submitUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!resp.ok) {
                            let msg = `Submission failed (${resp.status})`;
                            try { const j = await resp.json(); if (j && j.message) msg = j.message; } catch {}
                            throw new Error(msg);
                        }
                        status.className = 'text-sm text-green-700';
                        status.textContent = 'Thanks! Your details have been submitted.';
                        // Optionally clear the form
                        // form.reset();
                    } catch (err) {
                        status.className = 'text-sm text-red-700';
                        status.textContent = err && err.message ? err.message : 'An error occurred during submission.';
                    } finally {
                        setSubmittingState(false);
                    }
                });
            } catch (err) {
                loading.classList.add('hidden');
                errBox.classList.remove('hidden');
                errBox.textContent = err && err.message ? err.message : 'Unable to load form at this time.';
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
        
</html>
